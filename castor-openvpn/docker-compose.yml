services:
  app_proxy:
    image: getumbrel/app-proxy:1.0.0
    restart: unless-stopped
    environment:
      APP_HOST: web
      APP_PORT: 8080
      PROXY_AUTH_ADD: "true"
    depends_on:
      - web

  web:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "8080"
    volumes:
      - ${APP_DATA_DIR}/web:/usr/share/nginx/html:ro

  openvpn:
    image: kylemanna/openvpn:latest
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    ports:
      - "443:1194/tcp"
    volumes:
      - ${APP_DATA_DIR}/data:/etc/openvpn
    entrypoint: ["/bin/sh", "-lc"]
    command: |
      set -e
      if [ ! -f /etc/openvpn/openvpn.conf ]; then
        echo "[init] Initializing OpenVPN..."
        ovpn_genconfig -u tcp://0.0.0.0:1194 -n 1.1.1.1 -n 8.8.8.8
        echo "castor" | ovpn_initpki nopass
        echo "[init] Done"
      else
        echo "[init] Using existing config"
      fi
      exec ovpn_run

