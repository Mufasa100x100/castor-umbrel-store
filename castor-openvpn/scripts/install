#!/usr/bin/env bash
set -euo pipefail

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DATA_DIR="${APP_DIR}/data"

mkdir -p "${DATA_DIR}"

# IP local por defecto (válida LAN). En cliente podrás usar tu DDNS/IP pública si procede.
LAN_IP="$(hostname -I | awk '{print $1}')"
[ -n "${LAN_IP}" ] || LAN_IP="127.0.0.1"

# 1) Generar config si falta ovpn_env.sh (es lo que ovpn_run intenta sourcear)
if [ ! -f "${DATA_DIR}/ovpn_env.sh" ]; then
  echo "[install] Generating OpenVPN server config..."
  docker run --rm \
    -v "${DATA_DIR}:/etc/openvpn" \
    kylemanna/openvpn \
    ovpn_genconfig -u "tcp://${LAN_IP}:443" -n 1.1.1.1 -n 8.8.8.8
else
  echo "[install] ovpn_env.sh exists, skipping genconfig."
fi

# 2) Inicializar PKI si falta
if [ ! -d "${DATA_DIR}/pki" ]; then
  echo "[install] Initializing PKI..."
  docker run --rm \
    -e EASYRSA_BATCH=1 \
    -v "${DATA_DIR}:/etc/openvpn" \
    kylemanna/openvpn \
    ovpn_initpki nopass
else
  echo "[install] PKI exists, skipping initpki."
fi

echo "[install] OK"
